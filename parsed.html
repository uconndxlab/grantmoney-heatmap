<!DOCTYPE html>
<html>

<head>
  <title>Connecticut's NSF Grants</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <style>
    .header {
      background-color: rgb(34, 34, 34);
      box-shadow: 1px 1px 4px 0 rgb(0 0 0 / 10%);
      position: fixed;
      width: 100%;
      z-index: 3;
    }

    #mapView {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      width: 75%;
      height: auto;
      margin-top: 0%;
    }

    .hidden {
        opacity:0;
    }

    .marker-orange,
    .marker-red,
    .marker-green,
    .marker-blue,
    .marker-yellow {
      background-size: cover;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      cursor: pointer;
      background-color: #E4002B;
      box-shadow: 0px 0px 2px 0px rgba(0, 0, 0, 0.5);
      transition: 0.3s;
      transform-origin: center;
    }

    .marker-red {
      background-image: url('img/mapbox-icon-red.png')
    }

    .marker-green {
      background-image: url('img/mapbox-icon-green-01.png')
    }

    .marker-blue {
      background-color: #000E2F;
    }

    .marker-yellow {
      background-image: url('img/mapbox-icon-yellow-01.png')
    }

    .emphasized {
      height: 14px;
      width: 14px;
      box-shadow: 0px 0px 2px 0px rgba(111, 219, 246, 0.708);
    }

    .v-list {
      height: 70vh;
      /* or any height you want */
      overflow-y: auto
    }

  </style>
</head>

<body>
  <div id="app">
    <v-app>
      <v-main>
        <v-app-bar color="#182A60" dark app prominent>
          <v-container fluid class="header-container">
            <v-row style="margin-top:5px">
              <!-- <v-col
            class="d-flex"
            cols="12"
            sm="6"
          >
                <v-select
                v-model="inst_type"
                :items="ins_types"
                @change="doInst"
                filled
                label="Institution Type"
                dense
                ></v-select>
            </v-col> -->
              <v-col style="padding-top:25px;">
                <v-toolbar-title>Connecticut's NSF Grants</v-toolbar-title>

              </v-col>
              <v-col class="d-flex" cols="6" sm="6">
                <v-select :items="years" filled label="Year" v-model="current_year" @change="filterResultsByCurrentState()" dense>
                </v-select>               
              </v-col>
            </v-row>
          </v-container>
        </v-app-bar>

        <v-container fluid>
          <v-row>
            <v-col cols="3">


                <v-btn @click="current_type='All'; filterResultsByCurrentState();">
                    All
                </v-btn>

                <v-btn @click="current_type='highed'; filterResultsByCurrentState();">
                    <span style="margin-right:10px;" class="marker-blue"></span> High Ed
                </v-btn>
                  <v-btn @click="current_type='city'; filterResultsByCurrentState();">
                    <span style="margin-right:10px;" class="marker-orange"></span> Cities
                  </v-btn>

              <!-- <v-tabs v-model="resultsTab">
                <v-tabs-slider></v-tabs-slider>
                <v-tab @click="" >
                  All
                </v-tab>
                <v-tab @click="filterResultsByType('highed');">
                  <span style="margin-right:10px;" class="marker-blue"></span> High Ed
                </v-tab>
                <v-tab @click="filterResultsByType('city');">
                  <span style="margin-right:10px;" class="marker-orange"></span> Cities
                </v-tab>
              </v-tabs> -->

              <v-tabs-items v-model="resultsTab">
                <v-tab-item style="padding-top:20px;">
                    <h3>Institutions  
                        <v-chip 
                        v-if="current_year == 'All' "
                        class="ma-2"
                        
                    >
                        All Years
                    </v-chip>
                    <v-chip 
                    v-if="current_year != 'All' "
                    class="ma-2"
                    close
                    @click:close="current_year = 'All'; filterResultsByCurrentState();"
                >
                    {{current_year}}
                </v-chip>   
                <v-chip 
                    v-if="current_type == 'All' "
                    class="ma-2"
                    
                >
                    All Types
                </v-chip>
                        



                               

        
        
                    <v-chip 
                    v-if="current_type != 'All' "
                    class="ma-2"
                    close
                    @click:close="current_type = 'All'; filterResultsByCurrentState();"
                    >
                    {{current_type}}
                    </v-chip>
                   </h3>
                    <v-list>
                        <v-list-item-group>
                          <v-list-item v-for="ins in activeResults" :key="ins.Institution_Name" @click="doActivate(ins)">
                            
                            <v-list-item-icon v-if="ins.type == 'city'">
                                <span class="marker-orange"></span>                            
                            </v-list-item-icon>
                            <v-list-item-icon v-if="ins.type == 'highed'">
                                <span class="marker-blue"></span>                            
                            </v-list-item-icon>                            
                            <v-list-item-content>
                              <v-list-item-title>{{ins.Institution_Name}}</v-list-item-title>
                              <span v-if="current_year !== 'All'"><strong>{{current_year}}: </strong>{{ins['Award_Amount_' + current_year] | toUSD}} </span>
                              <span v-if="current_year == 'All'"><strong>Total Awards (2011-2022) </strong>{{ins['total_award'] | toUSD}} </span>

                            </v-list-item-content>
                          </v-list-item>
                        </v-list-item-group>
                      </v-list>
                </v-tab-item>
                <v-tab-item style="padding-top:20px;">
                  <v-list>
                    <v-list-item-group>
                      <v-list-item v-for="ins in highEd" :key="ins.Institution_Name" v-if="ins.active">
                        <v-list-item-icon v-if="ins.type == 'city'">
                            <span class="marker-orange"></span>                            
                        </v-list-item-icon>
                        <v-list-item-icon v-if="ins.type == 'highed'">
                            <span class="marker-blue"></span>                            
                        </v-list-item-icon>
                        <v-list-item-content>
                          <v-list-item-title>{{ins.Institution_Name}}</v-list-item-title>
                        </v-list-item-content>
                      </v-list-item>
                    </v-list-item-group>
                  </v-list>
                </v-tab-item>

                <v-tab-item style="padding-top:20px;">
                  <v-list>
                    <v-list-item-group>
                      <v-list-item v-for="ins in cities" :key="cities.Institution_Name">
                        <v-list-item-icon v-if="ins.type == 'city'">
                            <span class="marker-orange"></span>                            
                        </v-list-item-icon>
                        <v-list-item-icon v-if="ins.type == 'highed'">
                            <span class="marker-blue"></span>                            
                        </v-list-item-icon>
                        <v-list-item-content>
                          <v-list-item-title>{{ins.Institution_Name}}</v-list-item-title>
                        </v-list-item-content>
                      </v-list-item>
                    </v-list-item-group>
                  </v-list>
                </v-tab-item>


              </v-tabs-items>

            </v-col>
            <v-col cols="9">

              <div id="mapView"></div>
            </v-col>
          </v-row>
        </v-container>

<v-dialog
      v-model="showActiveInst"
      scrollable
      max-width="600px"
    >
    <v-card>
        <v-card-title>{{activeInst.Institution_Name}}</v-card-title>
        <v-divider></v-divider>
        <v-card-text style="height: 300px;">
            <v-simple-table>
                <template v-slot:default>
                  <tbody>
                    <tr>
                      <td>Total Award:</td>
                      <td>${{ activeInst.total_award }}</td>
                    </tr>

                    <tr>
                        <td>Total Jobs Created:</td>
                        <td>{{ activeInst.total_jobs }}</td>
                    </tr>

                    <tr>
                        <td>Award Amount 2011</td>
                        <td>${{ activeInst.Award_Amount_2011 }}</td>
                    </tr>

                    <tr>
                        <td>Award Amount 2012</td>
                        <td>${{ activeInst.Award_Amount_2012 }}</td>
                    </tr>
                    
                    <tr>
                        <td>Award Amount 2013</td>
                        <td>${{ activeInst.Award_Amount_2013 }}</td>
                    </tr>                    


                    <tr>
                        <td>Award Amount 2014</td>
                        <td>${{ activeInst.Award_Amount_2014 }}</td>
                    </tr>

                    <tr>
                        <td>Award Amount 2015</td>
                        <td>${{ activeInst.Award_Amount_2015 }}</td>
                    </tr>

                    <tr>
                        <td>Award Amount 2016</td>
                        <td>${{ activeInst.Award_Amount_2016 }}</td>
                    </tr>

                    <tr>
                        <td>Award Amount 2017</td>
                        <td>${{ activeInst.Award_Amount_2017 }}</td>
                    </tr>

                    <tr>
                        <td>Award Amount 2018</td>
                        <td>${{ activeInst.Award_Amount_2018 }}</td>
                    </tr>

                    <tr>
                        <td>Award Amount 2019</td>
                        <td>${{ activeInst.Award_Amount_2019 }}</td>
                    </tr>


                    <tr>
                        <td>Award Amount 2020</td>
                        <td>${{ activeInst.Award_Amount_2020 }}</td>
                    </tr>

                    <tr>
                        <td>Award Amount 2021</td>
                        <td>${{ activeInst.Award_Amount_2021 }}</td>
                    </tr>


                    <tr>
                        <td>Award Amount 2022</td>
                        <td>${{ activeInst.Award_Amount_2022 }}</td>
                    </tr>


                  </tbody>
                </template>
              </v-simple-table>
        </v-card-text>
        </v-card>
</v-dialog>



      </v-main>
    </v-app>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  <script>
    new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      data: () => ({
        map: "",
        jobs_max: 350,
        max_award_amount: 40,
        current_year: 'All',
        cities: [],
        current_type: "All",
        highEd: [],
        shownCityMarkers: [],
        shownHighEdMarkers: [],
        shownMarkers: [],
        resultsTab: 0,
        activeInst: {},
        showActiveInst:false,
        ins_types: [
          "City",
          "Higher Ed Institution"
        ],
        years: [
          'All', 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022
        ],

        combinedResults:[]
      }),
      computed:{
        activeResults() {
            var arr = this.combinedResults.filter(i => i.active == true);
            
            var sorted = arr.sort((a, b) => (a.total_award < b.total_award) ? 1 : -1)


            // inst_year_award =  inst_year_award.replace(/,/g, '');
            // inst_year_award = parseInt(inst_year_award);



            if(this.current_year !== "All")
                var sorted = arr.sort((a, b) => (parseInt(a['Award_Amount_' +this.current_year]) < parseInt(b['Award_Amount_'+this.current_year])) ? 1 : -1)


            return arr;

        }
      },
      mounted() {
        mapboxgl.accessToken =
          'pk.eyJ1Ijoiam9lbHVjb25uIiwiYSI6ImNrc3VtNDBndTFod3MybnFrbDRxN2EybHYifQ.2_iHqtCV_x6T78U4JD293g';
        const map = new mapboxgl.Map({
          container: 'mapView',
          style: 'mapbox://styles/mapbox/streets-v11',
          center: [-72.7, 41.45],
          zoom: 8.5
        });

        this.map = map;

        this.getCities();
        this.getHighEd();

      },

      filters: {
        toUSD (value) {
        return `$${value.toLocaleString()}`
        }
    },

      methods: {
        getCities() {
          let that = this;
          fetch('cities.json')
            .then(response => response.json())
            .then(function (data) {

              data.forEach(function (ins) {
                ins.total_award = 0;
                ins.total_jobs = 0;
                ins.type="city";
                ins.active= true;
                that.combinedResults.push(ins);
                that.cities.push(ins);
                console.log("this institution..." + ins.Institution_Name);
                
                that.years.forEach(function(year){
                    if (year !== "All") {
                        var year = year.toString();
                        var inst_year_award = ins['Award_Amount_' + year]
                        var inst_year_jobs = ins['jobs_' + year];

                        if(inst_year_award != "-") {
                            inst_year_award =  inst_year_award.replace(/,/g, '');
                            inst_year_award = parseInt(inst_year_award);
                            ins['Award_Amount_' + year] = inst_year_award;

                            console.log("this year..." + year + "..." + inst_year_award);

                            ins.total_award += parseInt(inst_year_award);
                            console.log("...and a total of .... " +ins.total_award);
                        } else {
                            ins['Award_Amount_' + year] = 0;
                        }


                        if(inst_year_jobs != "-") {
                            
                            inst_year_jobs = parseInt(inst_year_jobs);

                            ins.total_jobs += parseInt(inst_year_jobs);
                        } else {
                            ins['jobs_' + year] = 0;
                        }
                    }

                })

                

              })
              that.placeMarkers()
            })



        },

        getHighEd() {
          let that = this;
          fetch('high-ed.json')
            .then(response => response.json())
            .then(function (data) {
              data.forEach(function (ins) {
                ins.total_award = 0;
                ins.total_jobs = 0;
                ins.type = "highed";
                ins.active= true;
                that.combinedResults.push(ins);
                that.highEd.push(ins);

                console.log("this institution..." + ins.Institution_Name);
                
                that.years.forEach(function(year){
                    if (year !== "All") {
                        var year = year.toString();
                        var inst_year_award = ins['Award_Amount_' + year]
                        var inst_year_jobs = ins['jobs_' + year];

                        if(inst_year_award != "-") {
                            inst_year_award =  inst_year_award.replace(/,/g, '');
                            inst_year_award = parseInt(inst_year_award);
                            ins['Award_Amount_' + year] = inst_year_award;

                            console.log("this year..." + year + "..." + inst_year_award);

                            ins.total_award += parseInt(inst_year_award);
                            console.log("...and a total of .... " +ins.total_award);
                        } else {
                            ins['Award_Amount_' + year] = 0;
                        }


                        if(inst_year_jobs != "-") {
                            
                            inst_year_jobs = parseInt(inst_year_jobs);

                            ins.total_jobs += parseInt(inst_year_jobs);
                        } else {
                            ins['jobs_' + year] = 0;
                        }
                    }

                })



              })
              that.placeMarkers()
            })
        },

        filterResultsByCurrentState() {
            var type = this.current_type;
            var year = this.current_year;

            
            this.combinedResults.forEach(function(item){
                var award_year_amount = item['Award_Amount_'+year];
                
                if ((item.type == type) && (award_year_amount != "-")) {
                    item.active = true;
                } else {
                    item.active = false;
                }

                if((type=="All") && (award_year_amount != "-")){
                    item.active = true;
                }

            });

            console.log(this.activeResults);
            this.placeMarkers();
        },

        // filterResultsByYear() {
        //     var year = this.current_year;
        //     console.log("filter results by year");
        //     console.log(year);

        //     this.combinedResults.forEach(function(item){
        //         if(item['Award_Amount_'+year] != "-") {
        //             item.active = true
        //         } else {
        //             item.active = false;
        //     });
        //     this.placeMarkers();
        // },

        placeMarkers() {
          this.clearMarkers();
          var that = this;
          var data = that.activeResults;
          for (var i = 0; i < data.length; i++) {
            let inst = data[i];


            var el = document.createElement('div');
            el.classList.add('marker');

            switch (inst.type) {
                case 'highed':
                    el.classList.add ("marker-blue");
                    el.classList.add ("marker-high-ed");
                break;

                default:
                    el.classList.add ("marker-orange");
                    el.classList.add ("marker-high-city");
                break;
            }

            el.addEventListener('click', function(){that.doActivate(inst)});
            
            
            // that.years.forEach(function(yr){
            //         var year = yr.toString();
            //         var inst_year_award = inst['Award_Amount_' + year]
            //         var inst_year_jobs = inst['jobs_' + year];
                 
            //         if ( inst_year_award !== "-") {
            //             var key = 'award-amount-'+ year;
            //             el.setAttribute('data-' + key, inst_year_award);


            //             console.log("Dollars that year " + inst_year_award);

            //             var diameter = parseFloat(parseInt(inst_year_award) / parseInt(that.max_award_amount)) ;
            //             //console.log("diameter: " +  diameter);



            //         }

            //         if ( inst_year_jobs !== "-") {
            //             var key = 'jobs-'+ year;
            //             el.setAttribute('data-' + key, inst_year_jobs);
            //         }
            // });



                var mrk = new mapboxgl.Marker(el)
                .setLngLat([inst.x, inst.y])
                .addTo(that.map);

                this.shownMarkers.push(mrk);


            }
        },

        doActivate(inst){
            console.log(inst.Institution_Name);
            this.showActiveInst = true;

            this.activeInst = inst;
        },

        placeHighEdMarkers() {
          var that = this;
          var data = this.highEd;
          for (var i = 0; i < data.length; i++) {
            var inst = data[i];


            var el = document.createElement('div');
            el.classList.add('marker');
            el.classList.add ("marker-blue");
            el.classList.add ("marker-high-ed");
            
            that.years.forEach(function(yr){
                    var year = yr.toString();
                    var inst_year_award = inst['Award_Amount_' + year]
                    var inst_year_jobs = inst['jobs_' + year];
                 
                    if ( inst_year_award !== "-") {
                        var key = 'award-amount-'+ year;
                        el.setAttribute('data-' + key, inst_year_award);
                    }

                    if ( inst_year_jobs !== "-") {
                        var key = 'jobs-'+ year;
                        el.setAttribute('data-' + key, inst_year_jobs);
                    }
            });











            var mrk = new mapboxgl.Marker(el)
              .setLngLat([inst.x, inst.y])
              .addTo(that.map);

            this.shownHighEdMarkers.push(mrk);
          }
        },

        placeCityMarkers() {
          var that = this;
          var data = this.cities;
          for (var i = 0; i < data.length; i++) {
            var inst = data[i];

            var el = document.createElement('div');
            el.classList.add('marker');
            el.classList.add("marker-orange");
            el.classList.add("marker-city");

            that.years.forEach(function(yr){
                    var year = yr.toString();
                    var inst_year_award = inst['Award_Amount_' + year]
                    var inst_year_jobs = inst['jobs_' + year];
                 
                    if ( inst_year_award !== "-") {
                        var key = 'award-amount-'+ year;
                        el.setAttribute('data-' + key, inst_year_award);
                    }

                    if ( inst_year_jobs !== "-") {
                        var key = 'jobs-'+ year;
                        el.setAttribute('data-' + key, inst_year_jobs);
                    }
            });

            var mrk = new mapboxgl.Marker(el)
              .setLngLat([inst.x, inst.y])
              .addTo(that.map);

            this.shownCityMarkers.push(mrk);
          }

        },

        emphasize(selector) {
          var items = document.querySelectorAll(selector);
          items.forEach(function (item) {
            item.classList.remove('hidden');
          })
        },

        hide(selector){
            var items = document.querySelectorAll(selector);
            items.forEach(function (item) {
                item.classList.add('hidden');
            })
        },

        show(selector) {
            var items = document.querySelectorAll(selector);
            items.forEach(function (item) {
                item.classList.remove('hidden');
            })
        },

        deEmphasize(selector) {
          var items = document.querySelectorAll(selector);
          items.forEach(function (item) {
            item.classList.remove('emphasized');
            item.classList.add('hidden');
          })
        },

        clearMarkers() {

            var markers = this.shownMarkers;
            markers.forEach(function (marker) {
                marker.remove();
            })

        },

        clearCityMarkers() {

          var markers = this.shownCityMarkers;
          markers.forEach(function (marker) {
            marker.remove();
          })

        },

        clearHighEdMarkers() {
          var markers = this.shownHighEdMarkers;
          markers.forEach(function (marker) {
            marker.remove();
          })
        },

        placeMarkersAgain() {
        //   this.placeCityMarkers();
        //   this.placeHighEdMarkers();
        },

        changeYear() {

            this.filterResultsOnKey('')

            // let that = this;
            // this.placeMarkersAgain();
            // var markers = document.querySelectorAll('.marker');                

            // markers.forEach(function(marker){
            //     if(that.current_year !== "All") {
            //         marker.classList.add('hidden');
            //         var key = marker.dataset["awardAmount-" + that.current_year]
                    
            //         if(key != undefined) {
            //             marker.classList.remove('hidden');
            //         }
            //     } else {
            //         marker.classList.remove('hidden');
            //     }
                
            // });
        },

        changeInst_Type() {
          switch (this.inst_type) {
            case "Higher Ed Institution":
              this.hide('.marker-city');
              this.show('.marker-high-ed')
              break;

            case "City":
                this.hide('.marker-high-ed');
                this.show('.marker-city')
              break;
          }
        }
      }
    })

  </script>


</body>

</html>
